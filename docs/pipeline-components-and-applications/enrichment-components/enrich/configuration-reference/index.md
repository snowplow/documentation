---
title: "Configuration"
date: "2021-08-14"
sidebar_position: 50
---

## enrich-pubsub

A minimal configuration file can be found on the [Github repo](https://github.com/snowplow/enrich/blob/master/config/config.pubsub.minimal.hocon), as well as a [comprehensive one](https://github.com/snowplow/enrich/blob/master/config/config.pubsub.extended.hocon).

| input.subscription         | Required. PubSub subscription identifier for the collector payloads.Example: projects/example-project/subscriptions/collectorPayloads                                                                                                                                                                                                                                                                                                                                               |
|----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| input.parallelPullCount    | Optional. Number of threads used internally by permutive library to handle incoming messages. These threads do very little "work" apart from writing the message to a concurrent Queue.Default: 1                                                                                                                                                                                                                                                                                   |
| input.maxQueueSize         | Optional. Configures the "max outstanding element count" of PubSub. This is the principal way we control concurrency in the app; it puts an upper bound on the number of events in memory at once. An event counts towards this limit starting from when it received by the permutive library, until we ack it (after publishing to output). The value must be large enough that it does not cause the sink to block whilst it is waiting for a batch to be completed.Default: 3000 |
| output.good.topic          | Required. Name of the PubSub topic that will receive the enriched events.Example: projects/example-project/topics/enriched                                                                                                                                                                                                                                                                                                                                                          |
| output.good.attributes     | Optional. Enriched event fields to add as PubSub message attributes. For example, if this is [ "app_id" ] then the enriched event's app_id field will be an attribute of the PubSub message, as well as being a field within the message data                                                                                                                                                                                                                                       |
| output.good.delayThreshold | Optional. Delay threshold to use for batching. After this amount of time has elapsed, before maxBatchSize and maxBatchBytes have been reached, messages from the buffer will be sent.Default: 200 milliseconds                                                                                                                                                                                                                                                                      |
| output.good.maxBatchSize   | Optional. Maximum number of messages sent within a batch. When the buffer reaches this number of messages they are sent.Default: 1000 (PubSub maximum)                                                                                                                                                                                                                                                                                                                              |
| output.good.maxBatchBytes  | Optional. Maximum number of bytes sent within a batch. When the buffer reaches this size messages are sent.Default: 8000000 (PubSub maximum is 10MB)                                                                                                                                                                                                                                                                                                                                |
| output.pii.topic           | Optional. Should be used in conjunction with the PII pseudonymization enrichment. When configured, enables an extra output topic for writing a pii_transformation event.Example: projects/test-project/topics/pii                                                                                                                                                                                                                                                                   |
| output.pii.attributes      | Same as output.good.attributes for pii events                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| output.pii.delayThreshold  | Same as output.good.delayThreshold for pii events                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| output.pii.maxBatchSize    | Same as output.good.maxBatchSize for pii events                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| output.pii.maxBatchBytes   | Same as output.good.maxBatchBytes for pii events                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| output.bad.topic           | Required. Name of the PubSub topic that will receive the bad rows.Example: projects/example-project/topics/badrows                                                                                                                                                                                                                                                                                                                                                                  |
| output.bad.delayThreshold  | Same as output.good.delayThreshold for bad rows                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| output.bad.maxBatchSize    | Same as output.good.maxBatchSize for bad rows                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| output.bad.maxBatchBytes   | Same as output.good.maxBatchBytes for bad rows                                                                                                                                                                                                                                                                                                                                                                                                                                      |

## enrich-kinesis

A minimal configuration file can be found on the [Github repo](https://github.com/snowplow/enrich/blob/master/config/config.kinesis.minimal.hocon), as well as a [comprehensive one](https://github.com/snowplow/enrich/blob/master/config/config.kinesis.extended.hocon).

| input.appName                        | Optional. Name of the application which the KCL daemon should assume. A DynamoDB table with this name will be created.Default: snowplow-enrich-kinesis                                                                                                                                                                                                                                                        |
|--------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| input.streamName                     | Required. Name of the Kinesis stream with the collector payloads to read from                                                                                                                                                                                                                                                                                                                                 |
| input.region                         | Optional. Region where the Kinesis stream is located. This field is optional if it can be resolved with AWS region provider chain. It checks places like env variables, system properties, AWS profile file.                                                                                                                                                                                                  |
| input.initialPosition.type           | Optional. Set the initial position to consume the Kinesis stream. Possible values:- LATEST: most recent data- TRIM_HORIZON: oldest available data- AT_TIMESTAMP: start from the record at or after the specified timestampDefault: TRIM_HORIZON                                                                                                                                                               |
| input.initialPosition.timestamp      | Required for AT_TIMESTAMP.Example: 2020-07-17T10:00:00Z                                                                                                                                                                                                                                                                                                                                                       |
| input.retrievalMode.type             | Optional. Set the mode for retrieving records. Possible values:- Polling- FanOutDefault: Polling                                                                                                                                                                                                                                                                                                              |
| input.bufferSize                     | Optional. Size of the internal buffer used when reading messages from Kinesis, each buffer holding up to maxRecords from above.Default: 3                                                                                                                                                                                                                                                                     |
| input.customEndpoint                 | Optional. Endpoint url configuration to override aws kinesis endpoints. Can be used to specify local endpoint when using localstackExample: <http://localhost:4566>                                                                                                                                                                                                                                             |
| input.dynamodbCustomEndpoint         | Optional. Endpoint url configuration to override aws dyanomdb endpoint for Kinesis checkpoints lease table. Can be used to specify local endpoint when using localstack.Example: <http://localhost:4569>                                                                                                                                                                                                        |
| input.cloudwatchCustomEndpoint       | Optional. Endpoint url configuration to override aws cloudwatch endpoint for metrics. Can be used to specify local endpoint when using localstack.Example: <http://localhost:4582>                                                                                                                                                                                                                              |
| input.retrievalMode.maxRecords       | Required for Polling. Maximum size of a batch returned by a call to getRecords. Records are checkpointed after a batch has been fully processed, thus the smaller maxRecords, the more often records can be checkpointed into DynamoDb, but possibly reducing the throughput.Default: 10000                                                                                                                   |
| output.good.streamName               | Required. Name of the Kinesis stream to write to the enriched events.Example: enriched                                                                                                                                                                                                                                                                                                                        |
| output.good.region                   | Same as input.region for enriched events stream                                                                                                                                                                                                                                                                                                                                                               |
| output.good.partitionKey             | Optional. How the output stream will be partitioned in Kinesis. Events with the same partition key value will go to the same shard.Possible partition keys: event_id, event_fingerprint, domain_userid, network_userid, user_ipaddress, domain_sessionid, user_fingerprintRefer to this page to know what the possible partition keys correspond to.If not specified, the partition key will be a random UUID |
| output.good.backoffPolicy.minBackoff | Optional. Minimum backoff before retrying when writing fails.Default: 100 milliseconds                                                                                                                                                                                                                                                                                                                        |
| output.good.backoffPolicy.maxBackoff | Optional. Maximum backoff before retrying when writing fails.Default: 10 seconds                                                                                                                                                                                                                                                                                                                              |
| output.good.backoffPolicy.maxRetries | Optional. Maximum number of retries.Default: 10                                                                                                                                                                                                                                                                                                                                                               |
| output.good.recordLimit              | Optional. Limits the number of events in a single PutRecords request. Several requests are made in parallel.Default: 500                                                                                                                                                                                                                                                                                      |
| output.good.customEndpoint           | Optional. To use a custom Kinesis endpoint.Example: <https://localhost:4566>                                                                                                                                                                                                                                                                                                                                    |
| output.pii.streamName                | Optional. Should be used in conjunction with the PII pseudonymization enrichment. When configured, enables an extra output stream for writing a pii_transformation event.Example: pii                                                                                                                                                                                                                         |
| output.pii.region                    | Same as output.good.region for pii events                                                                                                                                                                                                                                                                                                                                                                     |
| output.pii.partitionKey              | Same as output.good.partitionKey for pii events                                                                                                                                                                                                                                                                                                                                                               |
| output.pii.backoffPolicy.minBackoff  | Same as output.good.backoffPolicy.minBackoff for pii events                                                                                                                                                                                                                                                                                                                                                   |
| output.pii.backoffPolicy.maxBackoff  | Same as output.good.backoffPolicy.maxBackoff for pii events                                                                                                                                                                                                                                                                                                                                                   |
| output.pii.backoffPolicy.maxRetries  | Same as output.good.backoffPolicy.maxRetries for pii events                                                                                                                                                                                                                                                                                                                                                   |
| output.pii.recordLimit               | Same as output.good.recordLimit for pii events                                                                                                                                                                                                                                                                                                                                                                |
| output.pii.customEndpoint            | Same as output.good.customEndpoint for pii events                                                                                                                                                                                                                                                                                                                                                             |
| output.bad.streamName                | Required. Name of the Kinesis stream to write to the bad rows.Example: bad                                                                                                                                                                                                                                                                                                                                    |
| output.bad.region                    | Same as output.good.region for bad rows                                                                                                                                                                                                                                                                                                                                                                       |
| output.bad.backoffPolicy.minBackoff  | Same as output.good.backoffPolicy.minBackoff for bad rows                                                                                                                                                                                                                                                                                                                                                     |
| output.bad.backoffPolicy.maxBackoff  | Same as output.good.backoffPolicy.maxBackoff for bad rows                                                                                                                                                                                                                                                                                                                                                     |
| output.bad.backoffPolicy.maxRetries  | Same as output.good.backoffPolicy.maxRetries for bad rows                                                                                                                                                                                                                                                                                                                                                     |
| output.bad.recordLimit               | Same as output.good.recordLimit for bad rows                                                                                                                                                                                                                                                                                                                                                                  |
| output.bad.customEndpoint            | Same as output.good.customEndpoint for pii events                                                                                                                                                                                                                                                                                                                                                             |

## Common parameters

| concurrency.enrich                 | Optional. Number of events that can get enriched at the same time within a chunk (events are processed by chunks in the app).Default: 256                                                                                                                                                                         |
|------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| concurrency.sink                   | Optional. Number of chunks that can get sunk at the same time.Default for enrich-pubsub: 3Default for enrich-kinesis: 1 (WARNING for enrich-kinesis: if greater than 1, records can get checkpointed before they are sunk)                                                                                        |
| assetsUpdatePeriod                 | Optional. Period after which enrich assets (e.g. the maxmind database for the IpLookups enrichment) should be checked for udpates. Assets will never be updated if this key is missing.Example: 7 days                                                                                                            |
| monitoring.sentry.dsn              | Optional. To track runtime exceptions in Sentry.Example: <http://sentry.acme.com>                                                                                                                                                                                                                                   |
| monitoring.metrics.statsd.hostname | Optional. Hostname of the StatsD server to send enrichment metrics (latency and event counts) to.Example: localhost                                                                                                                                                                                               |
| monitoring.metrics.statsd.port     | Optional. Port of the StatsD server.Example: 8125                                                                                                                                                                                                                                                                 |
| monitoring.metrics.statsd.period   | Optional. How frequently to report metricExample: 10 seconds                                                                                                                                                                                                                                                      |
| monitoring.metrics.statsd.tags     | Optional. Key-value pairs attached to each metric sent to StatsD to provide contextual information.Example" { "env": "prod" }                                                                                                                                                                                     |
| monitoring.metrics.statsd.prefix   | Optional. Configures the prefix of StatsD metric names.Default: snowplow.enrich.                                                                                                                                                                                                                                  |
| monitoring.metrics.stdout.period   | Optional. If set, metrics will be printed in the logs with this frequence.Example: 10 seconds                                                                                                                                                                                                                     |
| monitoring.metrics.stdout.prefix   | Optional. Prefix for the metrics appearing in the logs.Default: snowplow.enrich.                                                                                                                                                                                                                                  |
| telemetry.disable                  | Optional. Set to true to disable telemetry                                                                                                                                                                                                                                                                        |
| telemetry.interval                 | Optional. Interval for the heartbeat eventExample: 1 hour                                                                                                                                                                                                                                                         |
| telemetry.method                   | Optional. HTTP method used to send the heartbeat event.Possible values: GET or POST                                                                                                                                                                                                                               |
| telemetry.collectorUri             | Optional. hostname of the collector receiving the heartbeat event.Default: collector-g.snowplowanalytics.com                                                                                                                                                                                                      |
| telemetry.collectorPort            | Optional. Port of the collector receiving the heartbeat event.Example: 443                                                                                                                                                                                                                                        |
| telemetry.secure                   | Optional. Whether to use https or not.Default: true                                                                                                                                                                                                                                                               |
| telemetry.userProvidedId           | Optional. Identifier intended to tie events together across modules, infrastructure and apps when used consistently.Example: my_company                                                                                                                                                                           |
| telemetry.autoGeneratedId          | Optional. Intended to identify each independent module, and the infrastructure it controls                                                                                                                                                                                                                        |
| telemetry.instanceId               | Optional. Unique for each instance of the app running within a module                                                                                                                                                                                                                                             |
| telemetry.moduleName               | Optional. Name of the terraform module that deployed the app.Example: enrich-kinesis-ce                                                                                                                                                                                                                           |
| telemetry.moduleVersion            | Optional. Version of the terraform module that deployed the app.Example: 1.0.0                                                                                                                                                                                                                                    |
| featureFlags.acceptInvalid         | Optional. Enrich 3.0.0 introduces the validation of the enriched events against atomic schema before emitting. If set to false, a bad row will be emitted instead of the enriched event if validation fails. If set to true, invalid enriched events will be emitted, as before. More details here.Default: false |
| featureFlags.legacyEnrichmentOrder | Optional. In early versions of enrich-kinesis and enrich-pubsub (&lt;= 3.1.5), the Javascript enrichment incorrectly ran before the currency, weather, and IP Lookups enrichments.Set this flag to true to keep the erroneous behaviour of those previous versions.Default: false                                 |

Instead of Kinesis or PubSub, it's also possible to read collector payloads from files on disk. This can be used for instance for testing purposes. In this case the configuration needs to be as below.

| input.type | Should be FileSystem                                        |
|------------|-------------------------------------------------------------|
| input.dir  | Directory containing collector payloads encoded with Thrift |

Likewise, it's possible to write enriched events, pii events and bad rows to files instead of PubSub or Kinesis.

To write enriched events to files:

| input.type | Should be FileSystem                                        |
|------------|-------------------------------------------------------------|
| input.dir  | Directory containing collector payloads encoded with Thrift |

To write pii events to files:

| output.pii.type     | Should be FileSystem                                              |
|---------------------|-------------------------------------------------------------------|
| output.pii.file     | File where pii events will be written                             |
| output.pii.maxBytes | Optional. Maximum size of a file in bytes. Triggers file rotation |

To write bad rows to files:

| output.pii.type     | Should be FileSystem                                              |
|---------------------|-------------------------------------------------------------------|
| output.pii.file     | File where pii events will be written                             |
| output.pii.maxBytes | Optional. Maximum size of a file in bytes. Triggers file rotation |

## Enriched events validation against atomic schema

Enriched events are expected to match [atomic](https://github.com/snowplow/iglu-central/blob/master/schemas/com.snowplowanalytics.snowplow/atomic/jsonschema/1-0-0) schema.  
However, until 3.0.0, it was never checked that the enriched events emitted by enrich were valid.  
If an event is not valid against `atomic` schema, a bad row should be emitted instead of the enriched event.  
However, this is a breaking change, and we want to give some time to users to adapt, in case today they are working downstream with enriched events that are not valid against `atomic`.  
For this reason, this new validation was added as a feature that can be deactivated like that:

```json
"featureFlags": {
  "acceptInvalid": true
}
```

In this case, enriched events that are not valid against `atomic` schema will still be emitted as before, so that enrich 3.0.0 can be fully backward compatible.  
It will be possible to know if the new validation would have had an impact by 2 ways:

1. A new metric `invalid_enriched` has been introducred.  
    It reports the number of enriched events that were not valid against `atomic` schema. As the other metrics, it can be seen on stdout and/or StatsD.
2. Each time there is an enriched event invalid against `atomic` schema, a line will be logged with the bad row (add `-Dorg.slf4j.simpleLogger.log.InvalidEnriched=debug` to the `JAVA_OPTS` to see it).

If `acceptInvalid` is set to `false`, a bad row will be emitted instead of the enriched event in case it's not valid against `atomic` schema.

When we'll know that all our customers don't have any invalid enriched events any more, we'll remove the feature flags and it will be impossible to emit invalid enriched events.

## Telemetry

Starting with version 3.0.0 of enrich, snowplow will be collecting the heartbeats with some meta-information about the application (schema [here](https://raw.githubusercontent.com/snowplow/iglu-central/master/schemas/com.snowplowanalytics.oss/oss_context/jsonschema/1-0-1)). This is done to help us to improve the product, we need to understand what is popular, so we could focus our development effort in the right place.

At the base, telemetry is sending the application name and version every hour. You can help us by providing `userProvidedId` in the config file :

```json
"telemetry" {
  "userProvidedId": "myCompany"
}
```

Telemetry can be deactivated by putting the following section in the configuration file :

```json
"telemetry": {
  "disable": true
}
```

## Enrichments

The list of the enrichments that can be configured can be found on [this page](/docs/enriching-your-data/available-enrichments/index.md).
